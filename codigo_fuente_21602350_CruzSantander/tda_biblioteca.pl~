:- consult('TDA_fecha.pl').
:- consult('TDA_libro.pl').
:- consult('TDA_usuario.pl').
:- consult('TDA_prestamo.pl').

/*TDA biblioteca : estructura "biblioteca(B)" conformada por una lista con los elementos que identifican la bibliteca
; entre ellos libros, usuarios, prestamos, max libros  por persona, tasa de multa
;limite de la deuda, dias de retraso maximo y la fecha


 ;;;;;;;;;;;;;;;;;
 ; CONSTRUCTORES ;
 ;;;;;;;;;;;;;;;;;*/


/* TDA biblioteca constructor
 Descripción: funcion que permite crear una biblioteca.
 Dom: libros (lsit) X usuarios (list) X prestamos (list)) X max libros (int) X max dias prestamo(int)
 X tasa multa(int) X maxima deuda(int) X maximo retraso(int) X fecha(string)
 Rec: biblioteca(B)
*/
tdaBibliotecaCrear(Libros, Usuarios, Prestamos, MaxLibros, DiasMax, TasaMulta, LimiteDeuda, DiasRetraso, FechaBiblioteca, B) :-
    B= [libros(Libros),
        usuarios(Usuarios),
        prestamos(Prestamos),
        maxLibros(MaxLibros),
        diasMax(DiasMax),
        tasaMulta(TasaMulta),
        limiteDeuda(LimiteDeuda),
        diasRetraso(DiasRetraso),
        fechaBiblioteca(FechaBiblioteca)
       ].





/* TDA biblioteca pertenencia
 Descripción: funcion que permite comprobar si la biblioteca cumple con
 requisitos basicos para ser una biblioteca.
Dom: biblioteca (B)
Rec: boolean
*/

tdaBibliotecaEsBiblioteca(Biblioteca):-


       Biblioteca=[libros(Libros),
        usuarios(Usuarios),
        prestamos(Prestamos),
        maxLibros(MaxLibros),
        diasMax(DiasMax),
        tasaMulta(TasaMulta),
        limiteDeuda(LimiteDeuda),
        diasRetraso(DiasRetraso),
        fechaBiblioteca(FechaBiblioteca)
       ],
       is_list(Libros),
       is_list(Usuarios),
       is_list(Prestamos),
       integer(MaxLibros),
       integer(DiasMax),
       integer(TasaMulta),
       integer(LimiteDeuda),
       integer(DiasRetraso),
       tdaFechaEsFecha(FechaBiblioteca).


%///////////////////////Funciones selectoras///////////////////////////


/* TDA biblioteca Get Libros
 Descripción: funcion que obtiene la lista de libros de una biblioteca.
Dom: biblioteca (B)
Rec: Libros(List)
*/

tdaBibliotecaGetLibros(Biblioteca,Libros):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [libros(Libros)|_].



/* TDA biblioteca Get Usuarios
 Descripción: funcion que obtiene la lista de Usuarios de una biblioteca.
Dom: biblioteca (B)
Rec: Usuarios(List)
*/

tdaBibliotecaGetUsuarios(Biblioteca,Usuarios):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,usuarios(Usuarios)|_].





/* TDA biblioteca Get Prestamos
 Descripción: funcion que obtiene la lista de Prestamos de una biblioteca.
Dom: biblioteca (B)
Rec: Prestamos(List)
*/

tdaBibliotecaGetPrestamos(Biblioteca,Prestamos):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,_,prestamos(Prestamos)|_].




/* TDA biblioteca Get Max Libros
 Descripción: funcion que obtiene la cantidad maxima de libros por
 usuario en una biblioteca.
Dom: biblioteca (B)
Rec: MaxLibros(Int)
*/

tdaBibliotecaGetMaxLibros(Biblioteca,MaxLibros):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,_,_,maxLibros(MaxLibros)|_].





/* TDA biblioteca Get Dias Max
 Descripción: funcion que obtiene la cantidad maxima de dias por
 prestamo en una biblioteca.
Dom: biblioteca (B)
Rec: DiasMax(Int)
*/

tdaBibliotecaGetDiasMax(Biblioteca,DiasMax):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,_,_,_,diasMax(DiasMax)|_].






/* TDA biblioteca Get Tasa Multa
 Descripción: funcion que obtiene la tasa de multa por dia de retraso de
 una biblioteca.
Dom: biblioteca (B)
Rec: TasaMulta(Int)
*/

tdaBibliotecaGetTasaMulta(Biblioteca,TasaMulta):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,_,_,_,_,tasaMulta(TasaMulta)|_].





/* TDA biblioteca Get Limite Deuda
 Descripción: funcion que obtiene el limite de deuda acumulada de una
 biblioteca.
Dom: biblioteca (B)
Rec: LimiteDeuda(Int)
*/

tdaBibliotecaGetLimiteDeuda(Biblioteca,LimiteDeuda):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,_,_,_,_,_,limiteDeuda(LimiteDeuda)|_].






/* TDA biblioteca Get Dias Retraso
 Descripción: funcion que obtiene los dias maximos de retraso en una
 biblioteca.
Dom: biblioteca (B)
Rec: DiasRetdaso(Int)
*/

tdaBibliotecaGetDiasRetraso(Biblioteca,DiasRetraso):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,_,_,_,_,_,_,diasRetraso(DiasRetraso)|_].





/* TDA biblioteca Get Fecha
 Descripción: funcion que obtiene la Fecha Actual de una biblioteca.
Dom: biblioteca (B)
Rec: Fecha(String)
*/

tdaBibliotecaGetFecha(Biblioteca,FechaBiblioteca):-
    tdaBibliotecaEsBiblioteca(Biblioteca),
    Biblioteca= [_,_,_,_,_,_,_,_,fechaBiblioteca(FechaBiblioteca)|_].




%/////////MODIFICADORES////////////




/* TDA biblioteca Set Libros
 Descripción: funcion que modifica la lista de libros de una biblioteca
 y entrega una nueva.
Dom: bibliotecaIn(B) X LibroNuevos(list)
Rec: bibliotecaOut(B)
*/


tdaBibliotecaSetLibros(BibliotecaIn,LibrosNuevos,BibliotecaOut):-
                   tdaBibliotecaGetUsuarios(BibliotecaIn,Usuarios),
                   tdaBibliotecaGetPrestamos(BibliotecaIn,Prestamos),
                   tdaBibliotecaGetMaxLibros(BibliotecaIn,MaxLibros),
                   tdaBibliotecaGetDiasMax(BibliotecaIn,DiasMax),
                   tdaBibliotecaGetTasaMulta(BibliotecaIn,TasaMulta),
                   tdaBibliotecaGetLimiteDeuda(BibliotecaIn,LimiteDeuda),
                   tdaBibliotecaGetDiasRetraso(BibliotecaIn,DiasRetraso),
                   tdaBibliotecaGetFecha(BibliotecaIn,FechaBiblioteca),

                   tdaBibliotecaCrear(LibrosNuevos, Usuarios, Prestamos, MaxLibros, DiasMax, TasaMulta, LimiteDeuda, DiasRetraso, FechaBiblioteca, BibliotecaOut).



/* TDA biblioteca Set Usuarios
 Descripción: funcion que modifica la lista de Usuarios de una
 biblioteca y entrega una nueva.
Dom: bibliotecaIn(B) X UsuariosNuevos(list)
Rec: bibliotecaOut(B)
*/


tdaBibliotecaSetUsuarios(BibliotecaIn, UsuariosNuevos, BibliotecaOut) :-
                    tdaBibliotecaGetLibros(BibliotecaIn, Libros),
                    tdaBibliotecaGetPrestamos(BibliotecaIn, Prestamos),
                    tdaBibliotecaGetMaxLibros(BibliotecaIn, MaxLibros),
                    tdaBibliotecaGetDiasMax(BibliotecaIn, DiasMax),
                    tdaBibliotecaGetTasaMulta(BibliotecaIn, TasaMulta),
                    tdaBibliotecaGetLimiteDeuda(BibliotecaIn, LimiteDeuda),
                    tdaBibliotecaGetDiasRetraso(BibliotecaIn, DiasRetraso),
                    tdaBibliotecaGetFecha(BibliotecaIn, FechaBiblioteca),

                    tdaBibliotecaCrear(Libros, UsuariosNuevos, Prestamos, MaxLibros, DiasMax, TasaMulta, LimiteDeuda, DiasRetraso, FechaBiblioteca, BibliotecaOut).





/* TDA biblioteca Set Prestamos
 Descripción: funcion que modifica la lista de Prestamos de una
 biblioteca y entrega una nueva.
Dom: bibliotecaIn(B) X PrestamosNuevos(list)
Rec: bibliotecaOut(B)
*/

tdaBibliotecaSetPrestamos(BibliotecaIn, PrestamosNuevos, BibliotecaOut) :-
                    tdaBibliotecaGetLibros(BibliotecaIn, Libros),
                    tdaBibliotecaGetUsuarios(BibliotecaIn, Usuarios),
                    tdaBibliotecaGetMaxLibros(BibliotecaIn, MaxLibros),
                    tdaBibliotecaGetDiasMax(BibliotecaIn, DiasMax),
                    tdaBibliotecaGetTasaMulta(BibliotecaIn, TasaMulta),
                    tdaBibliotecaGetLimiteDeuda(BibliotecaIn, LimiteDeuda),
                    tdaBibliotecaGetDiasRetraso(BibliotecaIn, DiasRetraso),
                    tdaBibliotecaGetFecha(BibliotecaIn, FechaBiblioteca),

                    tdaBibliotecaCrear(Libros, Usuarios, PrestamosNuevos, MaxLibros, DiasMax, TasaMulta, LimiteDeuda, DiasRetraso, FechaBiblioteca, BibliotecaOut).





/* CheckIDLibro
 Descripción: funcion auxiliar que indica si un id fue encontrado en la
 lista de libros, hace uso de un getter de libro.
Dom: idDeseado(int) X Libros(list)
Rec: boolean
Tipo de recursion: de cola, ya que no deja operaciones pendientes
*/
%caso Base
checkIDLibro(_,[]):-
    false.

checkIDLibro(ID,[Libro|Resto]):-
    tdaLibroGetID(Libro,IDL),
        (ID=:= IDL -> true ;
        checkIDLibro(ID,Resto)).


/* CheckIDUsuario
 Descripción: funcion auxiliar que indica si un id fue encontrado en la
 lista de Usuarios, hace uso de un getter de Usuario.
Dom: idDeseado(int) X Usuarios(list)
Rec: boolean
Tipo de recursion: de cola, ya que no deja operaciones pendientes
*/
%caso Base
checkIDUsuario(_,[]):-
    false.
checkIDUsuario(ID,[Usuario|Resto]):-
    tdaUsuarioGetID(Usuario,IDU),
       (ID =:= IDU -> true;
       checkIDUsuario(ID,Resto)).


/* tdaBibliotecaCheckLibro
 Descripción: funcion auxiliar que indica si un libro esta disponible a
 partir de un id, hace uso de un getter de Libro.
Dom: idDeseado(int) X Libros(list)
Rec: boolean
Tipo de recursion: de cola, ya que no deja operaciones pendientes
*/
tdaBibliotecaCheckLibro(IDEsperado, [Libro|_]):-
    tdaLibroGetID(Libro,IDL),
    IDEsperado =:= IDL,!,
    tdaLibroGetEstado(Libro,Estado),
    Estado== disponible.

tdaBibliotecaCheckLibro(IDEsperado, [_|Resto]):-
    tdaBibliotecaCheckLibro(IDEsperado,Resto).





/* tdaBibliotecaSusU
 Descripción: funcion auxiliar que suspende un usuario segun su id, no
 altera si ya esta suspendido previamente, trabaja con listas.
Dom: Usuarios(list) X idUsuario(int)
Rec: UsuariosActualizados(list)
Tipo de recursion: de cola, no deja operaciones pendientes
*/

tdaBibliotecaSusU([], _, []).

tdaBibliotecaSusU([Usuario|Resto], IdTarget, [UsuarioModificado|Resto]) :-
    tdaUsuarioGetID(Usuario, IdActual),
    IdActual =:= IdTarget, !,
    tdaUsuarioSetEstado(Usuario, suspendido, UsuarioModificado).
tdaBibliotecaSusU([Usuario|Resto], IdTarget, [Usuario|RestoModificado]) :-
    tdaBibliotecaSusU(Resto, IdTarget, RestoModificado).





filtrarYFormatearUsuario([], _, "").

% Caso Recursivo 1: El préstamo pertenece al usuario
filtrarYFormatearUsuario([P|Resto], IdUsuario, StrFinal) :-
    tdaPrestamoGetIDUsuario(P, IdU),
    IdU =:= IdUsuario, !, % Cut para optimizar, encontramos al usuario

    % 1. Extraemos datos con los Getters oficiales
    tdaPrestamoGetID(P, IdP),
    tdaPrestamoGetIdLibro(P, IdL),
    tdaPrestamoGetFecha(P, FechaInicio),
    tdaPrestamoGetDias(P, Dias),
    tdaPrestamoGetEstado(P, Estado), % <--- Nuevo Getter

    % 2. Calculamos Vencimiento
    sumarDias(FechaInicio, Dias, FechaVenc),

    % 3. Formateamos la línea
    format(string(Linea), "Préstamo #~w - Libro ~w - Prestado: ~w - Vence: ~w - ~w\n",
           [IdP, IdL, FechaInicio, FechaVenc, Estado]),

    % 4. Recursión y concatenación
    filtrarYFormatearUsuario(Resto, IdUsuario, StrResto),
    string_concat(Linea, StrResto, StrFinal).

% Caso Recursivo 2: El préstamo NO pertenece al usuario
filtrarYFormatearUsuario([_|Resto], IdUsuario, StrFinal) :-
    filtrarYFormatearUsuario(Resto, IdUsuario, StrFinal).










formatearTodosPrestamos([], "").

% Caso Recursivo: Procesa cada préstamo de la lista
formatearTodosPrestamos([P|Resto], StrFinal) :-
    % 1. Extraemos datos con Getters oficiales
    tdaPrestamoGetID(P, IdP),
    tdaPrestamoGetIDUsuario(P, IdU),
    tdaPrestamoGetIdLibro(P, IdL),
    tdaPrestamoGetFecha(P, Fecha),
    tdaPrestamoGetDias(P, Dias),
    tdaPrestamoGetEstado(P, Estado), % <--- Nuevo Getter

    % 2. Formateamos: "ID P - ID U - ID L - Fecha - Dias - Estado"
    format(string(Linea), "Préstamo #~w: Usuario ~w - Libro ~w - Fecha: ~w - Días: ~w - ~w\n",
           [IdP, IdU, IdL, Fecha, Dias, Estado]),

    % 3. Recursión y unión
    formatearTodosPrestamos(Resto, StrResto),
    string_concat(Linea, StrResto, StrFinal).
